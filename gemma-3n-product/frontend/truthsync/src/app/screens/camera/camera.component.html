<div class="min-h-screen bg-black relative camera-container">
  <!-- 카메라 비디오 스트림 -->
  <video 
    #video 
    autoplay 
    playsinline 
    muted 
    class="w-full h-full object-cover"
    [class.hidden]="capturedImage"
  ></video>
  
  <!-- 캡처된 이미지 -->
  <img 
    *ngIf="capturedImage" 
    [src]="capturedImage" 
    class="w-full h-full object-cover"
    alt="촬영된 이미지"
  >
  
  <!-- 캔버스 (숨김) -->
  <canvas #canvas class="hidden"></canvas>
  
  <!-- 카메라가 비활성화된 경우 플레이스홀더 -->
  <div *ngIf="!isCameraActive && !capturedImage" class="absolute inset-0 bg-gray-800 flex items-center justify-center z-20">
    <div class="text-center text-white px-4">
      <span class="material-icons text-gray-400 mb-4" style="font-size: 64px;">photo_camera</span>
      <p class="text-lg mb-2">카메라 초기화 중...</p>
      <p *ngIf="errorMessage" class="text-sm text-red-400 mb-4">{{ errorMessage }}</p>
      <div class="flex flex-col space-y-2">
        <button 
          (click)="restartCamera()"
          class="px-6 py-3 bg-blue-500 rounded-lg text-white font-medium"
        >
          카메라 재시작
        </button>
        <button 
          *ngIf="errorMessage"
          (click)="initializeCamera()"
          class="px-6 py-3 bg-gray-600 rounded-lg text-white"
        >
          다시 시도
        </button>
      </div>
    </div>
  </div>
  
  <!-- 상단 UI -->
  <div class="absolute top-0 left-0 right-0 p-4 z-30">
    <div class="flex justify-between items-center">
      <!-- 왼쪽: 뒤로가기 버튼 -->
      <a 
        (click)="goToHome()"
        class="w-12 h-12 bg-black/50 rounded-full flex items-center justify-center backdrop-blur-sm ui-button cursor-pointer hover:bg-black/70 transition-all"
      >
        <span class="text-white text-xl">×</span>
      </a>
      
      <!-- 오른쪽: 기능 버튼들 -->
      <div class="flex items-center space-x-2">
        <!-- 정보 표시 영역 -->
        <div class="flex items-center space-x-2">
          <!-- 위치 정보 표시 -->
          <div *ngIf="locationString && locationString !== '위치 확인 실패' && locationString !== '위치 정보 없음'" 
               class="bg-blue-500/90 px-3 py-1.5 rounded-full backdrop-blur-sm border border-blue-400/30 max-w-32">
            <div class="flex items-center space-x-1">
              <span class="material-icons text-white text-xs flex-shrink-0">location_on</span>
              <span class="text-white text-xs font-medium truncate" [title]="locationString">{{ locationString }}</span>
            </div>
          </div>
          
          <!-- 방향 정보 표시 -->
          <div *ngIf="currentOrientation" 
               class="bg-green-500/90 px-3 py-1.5 rounded-full backdrop-blur-sm border border-green-400/30 max-w-20">
            <div class="flex items-center space-x-1">
              <span class="material-icons text-white text-xs flex-shrink-0">
                {{ currentOrientation.type === 'landscape' ? 'screen_rotation' : 'screen_lock_portrait' }}
              </span>
              <span class="text-white text-xs font-medium truncate">
                {{ currentOrientation.type === 'landscape' ? '가로' : '세로' }}
              </span>
            </div>
          </div>
        </div>
        
        <!-- 네트워크 상태 표시 -->
        <div *ngIf="!isOnline" class="w-10 h-10 bg-red-500/90 rounded-full flex items-center justify-center backdrop-blur-sm border border-red-400/30">
          <span class="text-white text-sm" title="오프라인">📶</span>
        </div>
        
        <!-- 플래시 버튼 -->
        <button 
          (click)="toggleFlash()"
          class="w-10 h-10 bg-black/50 rounded-full flex items-center justify-center backdrop-blur-sm ui-button hover:bg-black/70 transition-all"
          title="플래시"
        >
          <span class="text-white text-lg">⚡</span>
        </button>
        
        <!-- 카메라 전환 버튼 -->
        <button 
          (click)="switchCamera()"
          class="w-10 h-10 bg-black/50 rounded-full flex items-center justify-center backdrop-blur-sm ui-button hover:bg-black/70 transition-all"
          title="카메라 전환"
        >
          <span class="text-white text-lg">🔄</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- 카메라 화면 위 촬영 버튼 -->
  <div *ngIf="!capturedImage" class="absolute top-1/2 right-4 transform -translate-y-1/2 z-20">
    <button
      (click)="captureImage()"
      [disabled]="!isCameraActive || isCapturing"
      class="w-20 h-20 rounded-full border-3 border-white flex items-center justify-center transition-all disabled:opacity-50 bg-black/40 backdrop-blur-sm hover:bg-black/60"
      [ngClass]="isCapturing ? 'bg-red-500 border-red-400' : 'bg-black/40'"
      title="사진 촬영"
    >
      <div class="w-16 h-16 rounded-full bg-white shadow-lg"></div>
    </button>
  </div>
  
  <!-- 하단 UI (촬영 후) -->
  <div *ngIf="capturedImage" class="absolute bottom-0 left-0 right-0 p-6 z-20">
    <!-- 부연설명 입력 영역 -->
    <div *ngIf="!isStreaming && !finalArticle" class="bg-black/90 rounded-2xl p-6 text-white backdrop-blur-sm mb-4 border border-white/10">
      <div class="mb-4">
        <label class="block text-sm font-medium mb-3 text-gray-200">부연설명 (선택사항)</label>
        <textarea
          [(ngModel)]="userSubmessage"
          placeholder="이미지에 대한 추가 설명이나 특별히 분석하고 싶은 부분을 입력해주세요..."
          class="w-full p-4 bg-gray-800/70 border border-gray-600 rounded-xl text-white placeholder-gray-400 resize-none focus:border-blue-400 focus:outline-none transition-colors"
          rows="3"
          maxlength="500"
        ></textarea>
        <div class="text-xs text-gray-400 mt-2 text-right">
          {{ userSubmessage.length }}/500
        </div>
      </div>
      
      <!-- 재촬영/분석 버튼 -->
      <div class="flex justify-center space-x-4">
        <button
          (click)="retakePhoto()"
          class="px-6 py-3 bg-gray-600 hover:bg-gray-700 rounded-xl text-white font-medium transition-colors flex items-center space-x-2 min-w-0"
        >
          <span class="material-icons text-sm flex-shrink-0">refresh</span>
          <span class="whitespace-nowrap">다시 촬영</span>
        </button>
        <button
          (click)="analyzeImageStreaming()"
          [disabled]="isCapturing || !isModelReady"
          class="px-6 py-3 bg-blue-500 hover:bg-blue-600 rounded-xl text-white font-medium disabled:opacity-50 transition-colors flex items-center space-x-2 min-w-0"
          [title]="!isModelReady ? 'AI 모델 로딩 중입니다' : 'AI 분석'"
        >
          <span class="material-icons text-sm flex-shrink-0">psychology</span>
          <span class="whitespace-nowrap">AI 분석</span>
        </button>
      </div>
    </div>
    
    <!-- 스트리밍 분석 진행 상태 -->
    <div *ngIf="isStreaming" class="bg-black/90 rounded-2xl p-6 text-white backdrop-blur-sm mb-6 border border-white/10">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <div class="w-4 h-4 bg-green-500 rounded-full animate-pulse"></div>
          <span class="font-medium text-lg">AI 분석 중...</span>
        </div>
        <button
          (click)="stopStreaming()"
          class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg text-sm font-medium transition-colors"
          title="분석 중단"
        >
          중단
        </button>
      </div>
      
      <!-- 진행 메시지 -->
      <div class="text-sm text-gray-300 mb-4">
        {{ analysisMessage || 'AI가 이미지를 분석하고 있습니다...' }}
      </div>
      
      <!-- 스트리밍 텍스트 표시 (더 큰 영역) -->
      <div *ngIf="streamedText" class="bg-gray-900/70 rounded-xl p-4 max-h-48 overflow-y-auto text-display-area streaming-text border border-gray-700">
        <div class="text-sm text-gray-300 mb-3 font-medium flex items-center space-x-2">
          <span class="material-icons text-blue-400 text-sm">edit</span>
          <span>생성 중인 기사:</span>
        </div>
        <div class="text-white text-base leading-relaxed">
          {{ streamedText }}
          <span *ngIf="isStreaming" class="animate-pulse text-blue-400 typing-cursor">|</span>
        </div>
      </div>
      
      <!-- 애니메이션 진행 상태 -->
      <div class="space-y-3 text-sm mt-4 progress-indicator">
        <div class="flex justify-between items-center p-2 bg-gray-800/50 rounded-lg">
          <span class="text-gray-300">이미지 처리</span>
          <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span class="text-green-500 text-xs font-medium">완료</span>
          </div>
        </div>
        <div class="flex justify-between items-center p-2 bg-gray-800/50 rounded-lg">
          <span class="text-gray-300">AI 모델 로딩</span>
          <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span class="text-green-500 text-xs font-medium">완료</span>
          </div>
        </div>
        <div class="flex justify-between items-center p-2 bg-gray-800/50 rounded-lg">
          <span class="text-gray-300">기사 생성</span>
          <div class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
            <span class="text-yellow-500 text-xs font-medium">진행중</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 완료 상태 표시 -->
    <div *ngIf="!isStreaming && finalArticle" class="bg-green-500/90 rounded-2xl p-6 text-white backdrop-blur-sm mb-6 border border-green-400/30">
      <div class="flex items-center space-x-3 mb-4">
        <div class="w-4 h-4 bg-green-500 rounded-full"></div>
        <span class="font-medium text-lg">AI 분석 완료!</span>
      </div>
      
      <div class="text-sm text-gray-200 mb-4">
        분석이 완료되었습니다. 원하는 작업을 선택해주세요.
      </div>
      
      <!-- 완료된 텍스트 미리보기 (더 큰 영역) -->
      <div class="bg-gray-900/70 rounded-xl p-4 max-h-48 overflow-y-auto text-display-area completed-text mb-4 border border-gray-700">
        <div class="text-sm text-gray-300 mb-3 font-medium flex items-center space-x-2">
          <span class="material-icons text-green-400 text-sm">article</span>
          <span>생성된 기사:</span>
        </div>
        <div class="text-white text-base leading-relaxed">
          {{ finalArticle }}
        </div>
      </div>
      
      <!-- 작업 선택 버튼들 -->
      <div class="flex flex-col space-y-3">
        <!-- 사진에 적용 버튼 -->
        <button
          (click)="createDocument()"
          [disabled]="isCreatingDocument"
          class="w-full px-6 py-4 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 rounded-xl text-white font-medium transition-colors flex items-center justify-center space-x-2"
        >
          <span class="material-icons text-sm flex-shrink-0">add_photo_alternate</span>
          <span class="whitespace-nowrap">{{ isCreatingDocument ? '문서 생성 중...' : '사진에 적용' }}</span>
        </button>
        
        <!-- 재분석 버튼 -->
        <button
          (click)="reanalyzeImage()"
          class="w-full px-6 py-4 bg-gray-600 hover:bg-gray-700 rounded-xl text-white font-medium transition-colors flex items-center justify-center space-x-2"
        >
          <span class="material-icons text-sm flex-shrink-0">refresh</span>
          <span class="whitespace-nowrap">재분석</span>
        </button>
        
        <!-- 결과 페이지로 이동 버튼 -->
        <button
          (click)="goToPostDetail()"
          class="w-full px-6 py-4 bg-green-600 hover:bg-green-700 rounded-xl text-white font-medium transition-colors flex items-center justify-center space-x-2"
        >
          <span class="material-icons text-sm flex-shrink-0">article</span>
          <span class="whitespace-nowrap">결과 보기</span>
        </button>
      </div>
    </div>
    
    <!-- 일반 분석 진행 상태 -->
    <div *ngIf="isCapturing && !isStreaming" class="bg-black/90 rounded-2xl p-6 text-white backdrop-blur-sm border border-white/10">
      <div class="flex items-center space-x-3 mb-4">
        <div class="w-4 h-4 bg-green-500 rounded-full animate-pulse"></div>
        <span class="font-medium text-lg">AI 분석 중...</span>
      </div>
      
      <!-- 진행 메시지 -->
      <div class="text-sm text-gray-300 mb-4">
        {{ analysisMessage || 'AI가 이미지를 분석하고 있습니다...' }}
      </div>
      
      <div class="space-y-3 text-sm">
        <div class="flex justify-between items-center p-2 bg-gray-800/50 rounded-lg">
          <span class="text-gray-300">이미지 처리</span>
          <span class="text-green-500 text-xs font-medium">완료</span>
        </div>
        <div class="flex justify-between items-center p-2 bg-gray-800/50 rounded-lg">
          <span class="text-gray-300">AI 모델 로딩</span>
          <span class="text-green-500 text-xs font-medium">완료</span>
        </div>
        <div class="flex justify-between items-center p-2 bg-gray-800/50 rounded-lg">
          <span class="text-gray-300">기사 생성</span>
          <span class="text-yellow-500 text-xs font-medium">진행중</span>
        </div>
      </div>
    </div>
    
    <!-- 오류 메시지 -->
    <div *ngIf="errorMessage && !isCapturing && !isStreaming" class="bg-red-500/90 rounded-2xl p-6 text-white backdrop-blur-sm border border-red-400/30">
      <div class="flex items-center space-x-3 mb-4">
        <span class="material-icons text-red-200">warning</span>
        <span class="font-medium text-lg">오류 발생</span>
      </div>
      <div class="text-sm text-red-100 mb-4">
        {{ errorMessage }}
      </div>
      <!-- 서버 실행 안내 -->
      <div *ngIf="errorMessage.includes('서버') || errorMessage.includes('백엔드')" class="mt-4 p-4 bg-blue-500/50 rounded-xl border border-blue-400/30">
        <p class="text-sm font-medium mb-3 flex items-center space-x-2">
          <span class="material-icons text-sm">info</span>
          <span>서버 실행 방법:</span>
        </p>
        <div class="text-xs space-y-2">
          <p>1. 터미널에서 gemma-3n-product 폴더로 이동</p>
          <p>2. <code class="bg-black/30 px-2 py-1 rounded">./start_backend.sh</code> 실행</p>
          <p>3. 또는 <code class="bg-black/30 px-2 py-1 rounded">start-app.sh</code>에서 2번 선택</p>
          <p>4. ngrok URL이 자동으로 설정됩니다</p>
        </div>
      </div>
    </div>
    
    <!-- AI 모델 로딩 상태 -->
    <div *ngIf="!isModelReady && !isCapturing && !isStreaming" class="bg-blue-500/90 rounded-2xl p-6 text-white backdrop-blur-sm border border-blue-400/30">
      <div class="flex items-center space-x-3 mb-4">
        <span class="material-icons text-blue-200">psychology</span>
        <span class="font-medium text-lg">AI 모델 로딩 중</span>
      </div>
      <div class="text-sm text-blue-100">
        AI 모델을 로딩하고 있습니다. 잠시만 기다려주세요...
      </div>
    </div>
  </div>
  
  <!-- 카메라 가이드 오버레이 -->
  <div *ngIf="isCameraActive && !capturedImage" class="absolute inset-0 pointer-events-none z-10">
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
      <div class="w-72 h-72 border-2 border-white/50 rounded-lg camera-guide"></div>
      <div class="absolute top-0 left-0 w-full h-full border-4 border-white/20 rounded-lg"></div>
    </div>
    <div class="absolute bottom-40 left-1/2 transform -translate-x-1/2 text-center text-white/70">
      <p class="text-sm font-medium">사진을 촬영하여 AI 기사를 생성하세요</p>
      <p class="text-xs mt-1 opacity-60">가이드 라인 안에 피사체를 배치하세요</p>
    </div>
  </div>
  
  <!-- AI 분석 중 귀여운 애니메이션 오버레이 -->
  <div *ngIf="isStreaming" class="absolute inset-0 pointer-events-none z-50">
    <!-- 상단 AI 로봇 애니메이션 -->
    <div class="absolute top-8 left-1/2 transform -translate-x-1/2">
      <div class="ai-robot-animation">
        <div class="robot-face">
          <div class="robot-eyes">
            <div class="eye left-eye"></div>
            <div class="eye right-eye"></div>
          </div>
          <div class="robot-mouth"></div>
        </div>
        <div class="robot-body">
          <div class="processing-dots">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
          </div>
        </div>
        <div class="robot-text">AI 분석 중...</div>
      </div>
    </div>
    
    <!-- 중앙 회전하는 AI 아이콘 -->
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
      <div class="ai-spinner">
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="ai-brain">🧠</div>
      </div>
    </div>
  </div>
  
  <!-- 모바일 최적화 터치 영역 -->
  <div class="absolute inset-0 pointer-events-none">
    <!-- 터치 영역 확장을 위한 투명 버튼들 -->
    <div class="absolute top-0 left-0 w-20 h-20 pointer-events-auto"></div>
    <div class="absolute top-0 right-0 w-20 h-20 pointer-events-auto"></div>
  </div>
</div>
